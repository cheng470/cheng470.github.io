<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>ssh 配置使用多个 ssh key | cheng470 的博客</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="实现在 gitee.com 和 github.com 之间配置不同的 SSH-KEY 。"><meta name=generator content="Hugo 0.103.1"><meta name=robots content="noindex, nofollow"><link rel=stylesheet href=/ananke/css/main.min.css><meta property="og:title" content="ssh 配置使用多个 ssh key"><meta property="og:description" content="实现在 gitee.com 和 github.com 之间配置不同的 SSH-KEY 。"><meta property="og:type" content="article"><meta property="og:url" content="https://cheng470.github.io/posts/ssh-%E9%85%8D%E7%BD%AE%E4%BD%BF%E7%94%A8%E5%A4%9A%E4%B8%AA-ssh-key/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-22T23:43:54+08:00"><meta property="article:modified_time" content="2022-09-22T23:43:54+08:00"><meta itemprop=name content="ssh 配置使用多个 ssh key"><meta itemprop=description content="实现在 gitee.com 和 github.com 之间配置不同的 SSH-KEY 。"><meta itemprop=datePublished content="2022-09-22T23:43:54+08:00"><meta itemprop=dateModified content="2022-09-22T23:43:54+08:00"><meta itemprop=wordCount content="1041"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="ssh 配置使用多个 ssh key"><meta name=twitter:description content="实现在 gitee.com 和 github.com 之间配置不同的 SSH-KEY 。"></head><body class="ma0 avenir bg-near-white"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">cheng470 的博客</a><div class="flex-l items-center"><div class=ananke-socials></div></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">ssh 配置使用多个 ssh key</h1><time class="f6 mv4 dib tracked" datetime=2022-09-22T23:43:54+08:00>September 22, 2022</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>实现在 gitee.com 和 github.com 之间配置不同的 SSH-KEY 。</p><h2 id=生成两个-ssh-key>生成两个 SSH-KEY</h2><p>使用如下命令生成 <code>gitee.com</code> 和 <code>github.com</code> 的密钥对：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>ssh-keygen -t ed25519 -C <span style=color:#e6db74>&#34;593835672@qq.com&#34;</span>  -f ~/.ssh/gitee_id_ed25519
</span></span><span style=display:flex><span>ssh-keygen -t ed25519 -C <span style=color:#e6db74>&#34;593835672@qq.com&#34;</span>  -f ~/.ssh/github_id_ed25519
</span></span></code></pre></div><p>我在生成时都配置了密码短语，所以需要用到 <code>ssh-agent</code> 避免以后频繁输入密码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 启动 ssh-agent</span>
</span></span><span style=display:flex><span>% eval <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>ssh-agent -s<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>Agent pid <span style=color:#ae81ff>35502</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 添加，这里需要输入密码</span>
</span></span><span style=display:flex><span>% ssh-add ~/.ssh/gitee_id_ed25519
</span></span><span style=display:flex><span>% ssh-add ~/.ssh/github_id_ed25519
</span></span></code></pre></div><h2 id=配置>配置</h2><ul><li><p>新建一个 <code>~/.ssh/config</code> 文件，内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># gitee
</span></span><span style=display:flex><span>Host gitee.com
</span></span><span style=display:flex><span>HostName gitee.com
</span></span><span style=display:flex><span>PreferredAuthentications publickey
</span></span><span style=display:flex><span>IdentityFile ~/.ssh/gitee_id_ed25519
</span></span><span style=display:flex><span># github
</span></span><span style=display:flex><span>Host github.com
</span></span><span style=display:flex><span>HostName github.com
</span></span><span style=display:flex><span>PreferredAuthentications publickey
</span></span><span style=display:flex><span>IdentityFile ~/.ssh/github_id_ed25519
</span></span></code></pre></div></li><li><p>复制 <code>~/.ssh/xxx_id_ed25519.pub</code> 里面的内容，然后登陆 <code>gitee.com</code> 和 <code>github.com</code> 网站，到密钥管理处，添加对应的公钥。</p></li></ul><h2 id=测试>测试</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>% ssh -T git@github.com           
</span></span><span style=display:flex><span>Hi cheng470! You<span style=color:#e6db74>&#39;ve successfully authenticated, but GitHub does not provide shell access.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>% ssh -T git@gitee.com 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Hi cheng470! You&#39;</span>ve successfully authenticated, but GITEE.COM does not provide shell access.
</span></span></code></pre></div><h2 id=存在的问题>存在的问题</h2><p>使用 ssh-agent 后，有两个问题：</p><ol><li>ssh-agent 不支持开机自动启动，也不能自动添加指定的私钥</li><li>vscode 的 git 不支持 ssh-agent</li></ol><p>针对第一个问题，网上的方案大多是写一个启动 ssh-agent 的脚本，例如我参考网上的一些文章写的脚本：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># filename: ~/bin/ssh-agent.sh</span>
</span></span><span style=display:flex><span>ENV_FILE<span style=color:#f92672>=</span>~/.ssh/agent.env
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -f $ENV_FILE <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    . $ENV_FILE &gt;/dev/null
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ! kill -0 $SSH_AGENT_PID &gt;/dev/null 2&gt;&amp;1; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        eval <span style=color:#e6db74>`</span>ssh-agent |tee $ENV_FILE<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>        ssh-add ~/.ssh/gitee_id_ed25519 ~/.ssh/github_id_ed25519
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    eval <span style=color:#e6db74>`</span>ssh-agent |tee $ENV_FILE<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>    ssh-add ~/.ssh/gitee_id_ed25519 ~/.ssh/github_id_ed25519
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span></code></pre></div><p>之后添加 <code>. ~/bin/ssh-agent.sh</code> 到 <code>.zshrc</code> 中。</p><p>这样打开终端，输入密码一次，之后 ssh-agent 就一直在后台运行了，缺点就是每次重启之后要重新打开终端。</p><p>针对第二个问题，vscode git 插件的文档 <a href=https://code.visualstudio.com/docs/editor/versioncontrol#_common-questions>Version Control in Visual Studio Code</a> 里面是这么写的：</p><blockquote><p>Can I use SSH Git authentication with VS Code?</p><p>Yes, though VS Code works most easily with SSH keys without a passphrase. If you have an SSH key with a passphrase, you&rsquo;ll need to launch VS Code from a Git Bash prompt to inherit its SSH environment.</p></blockquote><p>所以不能通过桌面图标的方式启动 vscode ，只能从 bash 命令提示符启动，这样才能继承 ssh 环境变量。 在本地测试了下，确实可以用 git 插件了，就是不太方便。</p><p>这两种方案都不太好，后来我在 <a href=https://wiki.archlinux.org/title/SSH_keys_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)>SSH keys (简体中文) - ArchWiki</a> 里面找到一种 <code>systemd+pam</code> 的方式来解决 ssh-agent 带来的这两个问题。</p><blockquote><p>这 wiki 里面关于 ssh-agent 的用法写的很详细，记录各种不同的组合使用方式。</p></blockquote><p>其中 <code>systemd</code> 负责开机启动 ssh-agent ， <code>pam</code> 负责登陆成功后添加私钥到 ssh-agent ，全程不需要手动操作。</p><p>配置步骤如下：</p><ol><li><p>配置 <strong>systemd</strong> 启动 ssh-agent</p><ul><li><p>添加文件 <code>~/.config/systemd/user/ssh-agent.service</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>[Unit]
</span></span><span style=display:flex><span>Description=SSH key agent
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[Service]
</span></span><span style=display:flex><span>Type=simple
</span></span><span style=display:flex><span>Environment=SSH_AUTH_SOCK=%t/ssh-agent.socket
</span></span><span style=display:flex><span>Environment=DISPLAY=:0
</span></span><span style=display:flex><span>ExecStart=/usr/bin/ssh-agent -D -a $SSH_AUTH_SOCK
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[Install]
</span></span><span style=display:flex><span>WantedBy=default.target
</span></span></code></pre></div></li><li><p>设置开机自动运行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>systemctl enable ssh-agent --user
</span></span><span style=display:flex><span>systemctl start ssh-agent --user
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 启用 linger，作用是用户注销时 systemd --user 对应的服务不会退出</span>
</span></span><span style=display:flex><span>sudo loginctl enable-linger <span style=color:#66d9ef>$(</span>whoami<span style=color:#66d9ef>)</span>
</span></span></code></pre></div></li><li><p>完成</p></li></ul></li><li><p>配置 <strong>pam</strong> 在用户登陆成功后，自动添加私钥到 ssh-agent （完整的步骤可以看 <a href=https://github.com/capocasa/systemd-user-pam-ssh>capocasa/systemd-user-pam-ssh</a>）</p><ul><li><p>添加文件 <code>~/.pam_environment</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>echo <span style=color:#e6db74>&#39;SSH_AUTH_SOCK DEFAULT=&#34;${XDG_RUNTIME_DIR}/ssh-agent.socket&#34;&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>&gt; ~/.pam_environment
</span></span></code></pre></div></li><li><p>安装 systemd-user-pam-ssh 脚本</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo curl -o /usr/lib/systemd/systemd-user-pam-ssh <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>https://raw.githubusercontent.com/capocasa/systemd-user-pam-ssh/master/systemd-user-pam-ssh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo chmod +x /usr/lib/systemd/systemd-user-pam-ssh
</span></span></code></pre></div><p>由于我的密钥对没有使用默认名称，所以需要修改脚本里面 <code>ssh-add</code> 行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>ssh-add ~/.ssh/gitee_id_ed25519 ~/.ssh/github_id_ed25519
</span></span></code></pre></div></li><li><p>配置 pam</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>echo <span style=color:#e6db74>&#34;auth  optional  pam_exec.so  expose_authtok /usr/lib/systemd/systemd-user-pam-ssh&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>| sudo tee -a /etc/pam.d/system-login
</span></span></code></pre></div><blockquote><p>systemd-user-pam-ssh 脚本的作者是将该配置写入 <code>/etc/pam.d/login</code> 文件， 但我在本地测试并没有成功，后面改为写入 <code>/etc/pam.d/system-login</code> 才测试成功。</p></blockquote></li><li><p>加密存放密码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>read -s PASSWORD
</span></span><span style=display:flex><span><span style=color:#75715e># 输入系统密码</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>read -s PASSPHRASE
</span></span><span style=display:flex><span><span style=color:#75715e># 输入密钥的密码短语</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo $PASSPHRASE | openssl enc -pbkdf2 -in - -out ~/.ssh/passphrase -e -aes256 -k <span style=color:#e6db74>&#34;</span>$PASSWORD<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>unset PASSWORD
</span></span><span style=display:flex><span>unset PASSPHRASE
</span></span></code></pre></div></li></ul></li></ol><p>退出重新登陆后，用 <code>ssh-add -l</code> 命令检查。</p><h2 id=参考>参考</h2><ul><li><a href=https://gitee.com/help/articles/4229#article-header0>Git配置多个SSH-Key - Gitee.com</a></li><li><a href=https://wiki.archlinux.org/title/SSH_keys_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)>SSH keys (简体中文) - ArchWiki</a></li><li><a href=https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent>Generating a new SSH key and adding it to the ssh-agent - GitHub Docs</a></li><li><a href=https://github.com/capocasa/systemd-user-pam-ssh>capocasa/systemd-user-pam-ssh: Script used to decrypt a SSH key into a systemd &ndash;user managed ssh agnet</a></li><li><a href=https://code.visualstudio.com/docs/editor/versioncontrol#_common-questions>Version Control in Visual Studio Code</a></li></ul><ul class=pa0></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://cheng470.github.io/>&copy; cheng470 的博客 2022</a><div><div class=ananke-socials></div></div></div></footer></body></html>